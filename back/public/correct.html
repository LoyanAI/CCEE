<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>拍照矫正</title>
<style>
  :root{
    --brand:#0066ff;
    --bg:#f5f7fa;
    --radius:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    background:var(--bg);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    min-height:100vh;
  }
  h1{color:#333;margin-bottom:16px;font-size:22px}
  .card{
    background:#fff;
    border-radius:var(--radius);
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    max-width:480px;
    width:100%;
    padding:16px;
    text-align:center;
  }
  video,canvas,img{
    width:100%;
    border-radius:var(--radius);
    border:1px solid #e0e0e0;
    background:#000;
  }
  .btn{
    background:var(--brand);
    color:#fff;
    border:none;
    padding:10px 22px;
    margin:8px 4px;
    border-radius:var(--radius);
    font-size:15px;
    cursor:pointer;
    transition:background .2s;
  }
  .btn:hover{background:#0052d9}
  .btn:active{transform:translateY(1px)}
.in{
  width:100%;
  margin:4px 0 8px;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:var(--radius);
}
</style>
</head>
<body>

<h1>拍照矫正</h1>

<div class="card">
  <video id="video" autoplay playsinline></video>

  <button id="snap" class="btn">拍照</button>
  <button id="correct" class="btn" style="display:none">纠正</button>

  <canvas id="canvas" style="display:none"></canvas>
  <img id="result" style="display:none">

  <!-- 新增输入框 -->
  <div style="margin-top:12px;text-align:left">
    <label>文件路径：<input id="path" placeholder="/upload/2024" class="in"></label><br>
    <label>文件名：<input id="name" placeholder="corrected.jpg" class="in"></label><br>
    <label>文件信息：<input id="info" placeholder="备注..." class="in"></label>
  </div>

  <button id="upload" class="btn" style="display:none">上传</button>
</div>


<script>
/* ---------- 1. 摄像头 ---------- */
navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
  .then(s=>video.srcObject=s);

/* ---------- 2. 变量 ---------- */
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const video=document.getElementById('video');
const snapBtn=document.getElementById('snap');
const okBtn=document.getElementById('ok');
let imgData,quad=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],dragIndex=-1;

/* ---------- 3. 拍照 ---------- */
snapBtn.onclick=()=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);
  imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const {width:w,height:h}=canvas;
  quad=[{x:w*0.2,y:h*0.2},{x:w*0.8,y:h*0.2},
        {x:w*0.8,y:h*0.8},{x:w*0.2,y:h*0.8}];
  canvas.style.display='block';
  okBtn.style.display='inline-block';
  draw();
};

/* ---------- 4. 拖拽 ---------- */
canvas.onmousedown=e=>startDrag(e);
canvas.ontouchstart=e=>{startDrag(e.touches[0]);e.preventDefault();}
function startDrag(e){
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*canvas.width/rect.width;
  const y=(e.clientY-rect.top)*canvas.height/rect.height;
  dragIndex=quad.findIndex(p=>Math.hypot(p.x-x,p.y-y)<30);
}
canvas.onmousemove=e=>move(e);
canvas.ontouchmove=e=>{move(e.touches[0]);e.preventDefault();}
function move(e){
  if(dragIndex<0) return;
  const rect=canvas.getBoundingClientRect();
  quad[dragIndex].x=(e.clientX-rect.left)*canvas.width/rect.width;
  quad[dragIndex].y=(e.clientY-rect.top)*canvas.height/rect.height;
  draw();
}
canvas.onmouseup=canvas.ontouchend=()=>dragIndex=-1;

/* ---------- 5. 绘制 ---------- */
function draw(show=true){
  ctx.putImageData(imgData,0,0);
  if(!show) return;
  ctx.strokeStyle='#ff0033'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(quad[0].x,quad[0].y);
  quad.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.closePath(); ctx.stroke();
  ctx.fillStyle='#ff0033';
  quad.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,8,0,Math.PI*2);ctx.fill();});
}

/* ---------- 6. 纠正 ---------- */
let dstCanvas = null; // 用来保存纠正后的 canvas

/* ---------- 纠正按钮 ---------- */
const correctBtn = document.getElementById('correct');
const uploadBtn  = document.getElementById('upload');

snapBtn.onclick = () => {
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const {width:w, height:h} = canvas;
  quad = [
    {x:w*0.2, y:h*0.2}, {x:w*0.8, y:h*0.2},
    {x:w*0.8, y:h*0.8}, {x:w*0.2, y:h*0.8}
  ];
  canvas.style.display = 'block';
  correctBtn.style.display = 'inline-block';
  uploadBtn.style.display = 'none';
  draw();
};

correctBtn.onclick = () => {
  const w = Math.hypot(quad[0].x - quad[1].x, quad[0].y - quad[1].y) | 0;
  const h = Math.hypot(quad[0].x - quad[3].x, quad[0].y - quad[3].y) | 0;
  draw(false);
  dstCanvas = document.createElement('canvas');
  dstCanvas.width  = w;
  dstCanvas.height = h;
  warp(canvas, dstCanvas, quad.map(p => [p.x, p.y]), [[0,0],[w,0],[w,h],[0,h]]);
  document.getElementById('result').src = dstCanvas.toDataURL('image/jpeg', 0.9);
  document.getElementById('result').style.display = 'block';
  uploadBtn.style.display = 'inline-block';
  draw(true);
};

/* ---------- 上传按钮 ---------- */
uploadBtn.onclick = () => {
  if (!dstCanvas) return alert('请先纠正！');
  const path = document.getElementById('path').value.trim();
  const name = document.getElementById('name').value.trim() || 'corrected.jpg';
  const info = document.getElementById('info').value.trim();

  dstCanvas.toBlob(blob => {
    const fd = new FormData();
    fd.append('file', blob, name);
    fd.append('name',name);
    fd.append('path', path);
    fd.append('info', info);

    fetch('/api/upload', { method: 'POST', body: fd })
      .then(r => r.json())
      .then(r => alert('上传成功：' + r.url))
      .catch(err => alert('上传失败：' + err));
  });
};

/* ---------- 7. 透视变换 ---------- */
function getTransform(src,dst){
  const A=[],b=[];
  for(let i=0;i<4;i++){
    const [sx,sy]=src[i],[dx,dy]=dst[i];
    A.push([sx,sy,1,0,0,0,-sx*dx,-sy*dx]);
    A.push([0,0,0,sx,sy,1,-sx*dy,-sy*dy]);
    b.push(dx,dy);
  }
  const h=solve(A,b);
  return [h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],1];
}
function warp(srcCanvas,dstCanvas,srcQuad,dstQuad){
  const ctx=dstCanvas.getContext('2d');
  const w=dstCanvas.width,h=dstCanvas.height;
  const H=getTransform(srcQuad,dstQuad);
  ctx.clearRect(0,0,w,h);
  ctx.save();
  ctx.transform(H[0],H[3],H[1],H[4],H[2],H[5]);
  ctx.drawImage(srcCanvas,0,0);
  ctx.restore();
}
function solve(A,b){
  const n=A.length;
  for(let i=0;i<n;i++){
    let max=i;
    for(let k=i+1;k<n;k++) if(Math.abs(A[k][i])>Math.abs(A[max][i])) max=k;
    [A[i],A[max]]=[A[max],A[i]]; [b[i],b[max]]=[b[max],b[i]];
    for(let k=i+1;k<n;k++){
      const f=A[k][i]/A[i][i];
      for(let j=i;j<n;j++) A[k][j]-=f*A[i][j];
      b[k]-=f*b[i];
    }
  }
  const x=new Array(n);
  for(let i=n-1;i>=0;i--){
    x[i]=b[i];
    for(let j=i+1;j<n;j++) x[i]-=A[i][j]*x[j];
    x[i]/=A[i][i];
  }
  return x;
}
</script>
</body>
</html>